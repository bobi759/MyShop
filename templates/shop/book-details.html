{% extends 'base.html' %}
{% load static %}

{% block content %}

    <input type="hidden" id="csrf-token" value="{{ csrf_token }}">

    <div class="container mt-5">
        <div class="row" id="book-details-row"></div>


        <h1 class="text-center fw-bold mb-4" style="margin-top: 20px;">What Our Readers Say</h1>
        <div id="carouselExampleControls" class="carousel slide text-center carousel-dark" data-bs-ride="carousel">
            <div class="carousel-inner" id="reviews-carousel-inner">

            </div>

            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls"
                    data-bs-slide="prev">
                <span class="carousel-control-prev-icon text-body" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls"
                    data-bs-slide="next">
                <span class="carousel-control-next-icon text-body" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>

        <div class="text-center mt-4">
            <button class="btn btn-success px-4 py-2 rounded-pill" data-bs-toggle="modal" data-bs-target="#reviewModal">
                Write a Review
            </button>
        </div>


        <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-slideout modal-lg modal-fullscreen-sm-down">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold" id="reviewModalLabel">Write a Review</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="review-form">
                            <div class="mb-3">
                                <label for="review-title" class="form-label">Title</label>
                                <input type="text" class="form-control" id="review-title"
                                       placeholder="Give your review a title" required>
                            </div>
                            <div class="mb-3">
                                <label for="review-description" class="form-label">Description</label>
                                <textarea class="form-control" id="review-description" rows="5"
                                          placeholder="Share your thoughts..." required></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary px-3" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary px-4" onclick="postReview()">Submit</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-danger">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="errorModalLabel">Incomplete Review</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Both the <strong>Title</strong> and <strong>Description</strong> are required to submit a
                        review.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
            crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
            crossorigin="anonymous"></script>

    <script>
        let user_id;
        let cart_id;
        const book_id = {{ book_id }};
        const csrfToken = document.getElementById('csrf-token').value;

        function loadBookDetails(book) {
            let bookDetails = `
        <div class="col-md-5">
            <img src="${book.image}" class="book-image rounded" alt="${book.title}">
        </div>
        <div class="col-md-7">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home page' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'products' %}">All books</a></li>
                    <li class="breadcrumb-item"><a href="/products/?genre=${encodeURIComponent(book.genre.name)}">${book.genre.name}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">${book.title}</li>
                </ol>
            </nav>
            <h1 class="fw-bold">${book.title}</h1>
            <p class="text-muted">by <strong>${book.author}</strong></p>
            <h3 class="text-primary">$${book.price}</h3>
            <form id="add-to-cart-form">
                <label for="quantity" class="form-label">Quantity</label>
                <input type="number" id="quantity" class="form-control w-25" name="quantity" value="1" min="1">
                <button type="submit" class="btn btn-warning mt-3 px-4 py-2">Add To Cart</button>
            </form>
            <h4 class="mt-4">Book Details <span class="text-muted">ðŸ“–</span></h4>
            <p>${book.description}</p>
            <!-- OPTION 1: Button under book description -->
            <!--
            <div class="mt-3">
                <button class="btn btn-outline-primary px-4 py-2 rounded-pill">Write a Review</button>
            </div>
            -->
        </div>`;
            $("#book-details-row").html(bookDetails);
        }

        function takeBook() {
            $.ajax({
                type: "GET",
                url: `http://localhost:8000/api/book/${book_id}`,
                success: (book) => {
                    console.log(book)
                    loadBookDetails(book)
                },
                error: function (xhr) {
                    console.error("Error:", xhr.responseText);
                }
            })
        }

        $(document).on('submit', '#add-to-cart-form', function (e) {
            e.preventDefault();
            const quantity = document.getElementById("quantity").value;

            $.ajax({
                type: "POST",
                url: `http://localhost:8000/api/cart/${cart_id}/items/`,
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({
                    "product_id": book_id,
                    "quantity": quantity,
                }),
                success: function (data) {
                    console.log(`Posted on ${cart_id}`);
                    window.location.href = "/products/";
                },
                error: function (xhr) {
                    console.error("Error:", xhr.responseText);
                }
            });
        });

        function getCartId() {
            $.ajax({
                method: "GET",
                url: "http://localhost:8000/api/current-user/",
                success: (data) => {
                    cart_id = data["cart_id"];
                    user_id = data["id"]
                },
                error: (error) => {
                    console.log(error);
                }
            });
        }

        function loadReviews() {
            $.ajax({
                type: "GET",
                url: `http://localhost:8000/api/book/${book_id}/reviews/`,
                success: (reviews) => {
                    console.log(reviews)
                    const container = $('#reviews-carousel-inner');
                    container.empty();

                    if (reviews.length === 0) {
                        container.append(`
        <div class="carousel-item active">
            <div class="d-flex justify-content-center align-items-center" style="height: 300px;">
                <div>
                    <p class="text-muted fs-4 fw-semibold text-center mb-0">
                        No reviews yet. Be the first to share your thoughts!
                    </p>
                </div>
            </div>
        </div>
    `);

                        // Hide carousel controls when there are no reviews
                        $('.carousel-control-prev, .carousel-control-next').hide();
                        return;
                    }

                    $('.carousel-control-prev, .carousel-control-next').show();

                    reviews.forEach((review, index) => {
                        const isActive = index === 0 ? 'active' : '';
                        const img = review.user.profile.profile_picture || 'https://via.placeholder.com/150';

                        const html = `
                        <div class="carousel-item ${isActive}">
                            <img class="rounded-circle shadow-1-strong mb-4"
                                 src="${img}"
                                 alt="avatar" style="width: 150px; height: 150px; object-fit: cover;"  />
                            <div class="row d-flex justify-content-center">
                                <div class="col-lg-8">
                                    <h5 class="mb-3">${review.user.profile.first_name} ${review.user.profile.last_name}</h5>
                                    <p>${review.title}</p>
                                    <p class="text-muted">
                                        <i class="fas fa-quote-left pe-2"></i>
                                        ${review.description}
                                    </p>
                                </div>
                            </div>
                        </div>`;
                        container.append(html);
                    });
                },
                error: function (xhr) {
                    console.error("Error loading reviews:", xhr.responseText);
                }
            });
        }

        function postReview() {
            const title = document.getElementById("review-title").value.trim();
            const description = document.getElementById("review-description").value.trim();

            if (!title || !description) {
                const reviewModalEl = document.getElementById('reviewModal');
                const reviewModalInstance = bootstrap.Modal.getInstance(reviewModalEl);
                if (reviewModalInstance) {
                    reviewModalInstance.hide();
                }

                reviewModalEl.addEventListener('hidden.bs.modal', function () {
                    document.body.classList.remove('modal-open');
                    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

                    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                    errorModal.show();
                }, {once: true});

                return;
            }

            $.ajax({
                method: "POST",
                url: `http://localhost:8000/api/book/${book_id}/reviews/`,
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({
                    title: title,
                    description: description,
                    book: book_id,
                    user: user_id
                }),
                success: function () {
                    const reviewModalEl = document.getElementById('reviewModal');
                    const modalInstance = bootstrap.Modal.getInstance(reviewModalEl);
                    modalInstance.hide();

                    document.body.classList.remove('modal-open');
                    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

                    loadReviews();
                    document.getElementById("review-form").reset();
                },
                error: function (xhr) {

                }
            });
        }

        $(document).ready(function () {
            takeBook();
            loadReviews();
            getCartId();
        });
    </script>

{% endblock %}
