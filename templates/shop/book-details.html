{% extends 'base.html' %}
{% load static %}

{% block content %}

    <input type="hidden" id="csrf-token" value="{{ csrf_token }}">

    <div class="container mt-5">
        <div class="row">

        </div>
    </div>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>


    <script>

    
        let cart_id;
        
        const pathParts = window.location.pathname.split('/').filter(Boolean);
        const book_id = Number(pathParts[pathParts.length - 1]);

        const csrfToken = document.getElementById('csrf-token').value;

        function loadBookDetails(book) {


            let bookDetails = `

            <div class="col-md-5">
                <img src="${book.image}" class="img-fluid rounded" alt="${book.title}">
                <div class="d-flex mt-2">
                    {#                    <img src="{{ book.cover_image.url }}" class="img-thumbnail mx-1" width="60" alt="Thumbnail">#}
                    {#                    <img src="{{ book.alt_image1.url }}" class="img-thumbnail mx-1" width="60" alt="Thumbnail">#}
                    {#                    <img src="{{ book.alt_image2.url }}" class="img-thumbnail mx-1" width="60" alt="Thumbnail">#}
                </div>
            </div>

            <div class="col-md-7">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'home page' %}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'products' %}">All books</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'products' %}">${book.genre.name}</a></li>
                        <li class="breadcrumb-item active" aria-current="page">${book.title}</li>
                    </ol>
                </nav>

                <h1 class="fw-bold">${book.title}</h1>
                <p class="text-muted">by <strong>${book.author}</strong></p>
                <h3 class="text-primary">$${book.price}</h3>

                <!-- Book Purchase Form -->
                <form id="add-to-cart-form">
                    <label for="quantity" class="form-label">Quantity</label>
                    <input type="number" id="quantity" class="form-control w-25" name="quantity" value="1" min="1">

                    <button type="submit" class="btn btn-warning mt-3 px-4 py-2">Add To Cart</button>
                </form>

                <h4 class="mt-4">Book Details <span class="text-muted">ðŸ“–</span></h4>
                <p>${book.description}</p>
            </div>
        `
            $(".row").html(bookDetails);

        }

        function takeBook() {

            const pathParts = window.location.pathname.split('/').filter(Boolean);
            const book_id = Number(pathParts[pathParts.length - 1]);

            $.ajax({
                type: "GET",
                url: `http://localhost:8000/api/book/${book_id}`,
                success: (book) => {
                    console.log(book)
                    loadBookDetails(book)
                }
                ,
                error: function (xhr) {
                    console.error("Error:", xhr.responseText);
                }

            })
        }


        $(document).on('submit', '#add-to-cart-form', function (e) {
            e.preventDefault();

            const quantity = document.getElementById("quantity").value;

            $.ajax({
                type: "POST",
                url: `http://localhost:8000/api/cart/${cart_id}/items/`,
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/json",
                },
                data: JSON.stringify({
                    "product_id": book_id,
                    "quantity": quantity,
                }),
                success: function (data) {
                    console.log(`posted on ${cart_id}`)
                    console.log("Success:", data);
                    window.location.href = "/products/";
                },
                error: function (xhr) {
                    console.error("Error:", xhr.responseText);
                }
            });
        });


        


        function getCartId() {
            $.ajax({
                method: "GET",
                url: `http://localhost:8000/api/current-user/`,
                success: (data) => {
                    cart_id = data["cart_id"]
                    console.log(cart_id)
                },
                error: (error) => {
                    console.log(error);
                }
            });

        }

        $(document).ready(function () {
            takeBook();
            getCartId();
        });

    </script>

{% endblock %}

